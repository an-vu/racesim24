{% extends "base.html" %}

{% block title %}Home - NASCAR Manager '24{% endblock %}

{% block content %}
<body>
    <div class="content" style="text-align: center;">
        <h1 class="home-welcome">NASCAR Manager '24</h1>
        <h2 class="home-subheader">Update October 17 2024</h2>

        <!-- GAME LAYOUT -->
        <div class="placeholder-box" style="display: flex; flex-direction: column; align-items: center; gap: 20px; margin-top: 5px;">
            <!-- STANDINGS -->
            <div class="box" style="width: auto; height: auto; background-color: #f5f5f5; border: 1px solid #333; border-radius: 10px; padding: 20px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);">
                <h3 id="standings-title" style="text-align: center; margin-bottom: 20px;">Standings - Lap: 1</h3>
                <table class="standings-table">
                    <thead>
                        <tr>
                            <th>Position</th>
                            <th>Car #</th>
                            <th>Driver</th>
                            <th>To Leader</th>
                            <th>Total</th>
                            <th>Tire %</th>
                            <th>Fuel %</th>
                        </tr>
                    </thead>
                    <tbody id="standings-table-body">
                        <!-- Placeholder rows -->
                        <tr>
                            <td>1</td>
                            <td id="first-num">--</td>
                            <td id="first-driver">--</td>
                            <td id="first-time-leader">--</td>
                            <td id="first-time-total">--</td>
                            <td id="first-tire">--</td>
                            <td id="first-fuel">--</td>
                        </tr>
                        <tr>
                            <td>2</td>
                            <td id="second-num">--</td>
                            <td id="second-driver">--</td>
                            <td id="second-time-leader">--</td>
                            <td id="second-time-total">--</td>
                            <td id="second-tire">--</td>
                            <td id="second-fuel">--</td>
                        </tr>
                        <tr>
                            <td>3</td>
                            <td id="third-num">--</td>
                            <td id="third-driver">--</td>
                            <td id="third-time-leader">--</td>
                            <td id="third-time-total">--</td>
                            <td id="third-tire">--</td>
                            <td id="third-fuel">--</td>
                        </tr>
                        <tr>
                            <td>3</td>
                            <td id="fourth-num">--</td>
                            <td id="fourth-driver">--</td>
                            <td id="fourth-time-leader">--</td>
                            <td id="fourth-time-total">--</td>
                            <td id="fourth-tire">--</td>
                            <td id="fourth-fuel">--</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- PLAYER CONTROL CENTER -->
            <div style="display: flex; gap: 20px; justify-content: center; margin-top: 5px;">
                <!-- Control Center for Car 1 -->
                <div class="box" style="width: 250px; height: auto; background-color: #f5f5f5; border: 1px solid #333; border-radius: 10px; padding: 20px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);">
                    <h3 id="car-1-title" style="text-align: center;">Car #1</h3>
                    <p id="player-car-1-tire"><strong>Tire %:</strong> 85%</p>
                    <p id="player-car-1-fuel"><strong>Fuel %:</strong> 75%</p>
                    <button id="player-car-1-pit" style="width: 100%; padding: 10px; background-color: #ff5c5c; color: white; border: none; border-radius: 5px; cursor: pointer;">Pit</button>
                    
                    <!-- Strategy Level (Conserve to Attack) -->
                    <div style="margin-top: 20px;">
                        <p><strong>Strategy Level:</strong></p>
                        <div style="display: flex; justify-content: space-between;">
                            <label style="display: flex; flex-direction: column; align-items: center;">
                                <input type="radio" name="strategy1" value="1">
                                <span>1</span>
                            </label>
                            <label style="display: flex; flex-direction: column; align-items: center;">
                                <input type="radio" name="strategy1" value="2">
                                <span>2</span>
                            </label>
                            <label style="display: flex; flex-direction: column; align-items: center;">
                                <input type="radio" name="strategy1" value="3">
                                <span>3</span>
                            </label>
                            <label style="display: flex; flex-direction: column; align-items: center;">
                                <input type="radio" name="strategy1" value="4">
                                <span>4</span>
                            </label>
                            <label style="display: flex; flex-direction: column; align-items: center;">
                                <input type="radio" name="strategy1" value="5">
                                <span>5</span>
                            </label>
                        </div>

                        <!-- Conserve and Attack labels on the next line -->
                        <div style="display: flex; justify-content: space-between; margin-top: 10px;">
                            <span style="font-size: 0.9em; color: #555;">Conserve</span>
                            <span style="font-size: 0.9em; color: #555;">Attack</span>
                        </div>
                    </div>
                </div>

                <!-- Control Center for Car 2 -->
                <div class="box" style="width: 250px; height: auto; background-color: #f5f5f5; border: 1px solid #333; border-radius: 10px; padding: 20px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);">
                    <h3 id="car-2-title" style="text-align: center;">Car #2</h3>
                    <p id="player-car-2-tire"><strong>Tire %:</strong> 85%</p>
                    <p id="player-car-2-fuel"><strong>Fuel %:</strong> 75%</p>
                    <button id="player-car-2-pit" style="width: 100%; padding: 10px; background-color: #ff5c5c; color: white; border: none; border-radius: 5px; cursor: pointer;">Pit</button>
                    
                    <!-- Strategy Level (Conserve to Attack) -->
                    <div style="margin-top: 20px;">
                        <p><strong>Strategy Level:</strong></p>
                        <div style="display: flex; justify-content: space-between;">
                            <label style="display: flex; flex-direction: column; align-items: center;">
                                <input type="radio" name="strategy2" value="1">
                                <span>1</span>
                            </label>
                            <label style="display: flex; flex-direction: column; align-items: center;">
                                <input type="radio" name="strategy2" value="2">
                                <span>2</span>
                            </label>
                            <label style="display: flex; flex-direction: column; align-items: center;">
                                <input type="radio" name="strategy2" value="3">
                                <span>3</span>
                            </label>
                            <label style="display: flex; flex-direction: column; align-items: center;">
                                <input type="radio" name="strategy2" value="4">
                                <span>4</span>
                            </label>
                            <label style="display: flex; flex-direction: column; align-items: center;">
                                <input type="radio" name="strategy2" value="5">
                                <span>5</span>
                            </label>
                        </div>

                        <!-- Conserve and Attack labels on the next line -->
                        <div style="display: flex; justify-content: space-between; margin-top: 10px;">
                            <span style="font-size: 0.9em; color: #555;">Conserve</span>
                            <span style="font-size: 0.9em; color: #555;">Attack</span>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- RESET BUTTON -->
        <div style="margin-top: 30px;">
            <button id="lap-button" style="padding: 15px 30px; border: none; background-color: #ff5c5c; color: white; cursor: pointer; border-radius: 5px;">
                Advance Lap
            </button>
            <button id="reset-button" style="padding: 15px 30px; border: none; background-color: #ff5c5c; color: white; cursor: pointer; border-radius: 5px;">
                Reset
            </button>
        </div>
    </div>
    <script>
        // Function to fetch and display race data
        async function getRaceData() {
            try {
                const response = await fetch('/api/race');
                const data = await response.json();

                // Updating the standings table
                const standingsIds = [
                    { prefix: 'first', car: data.cars[0] },
                    { prefix: 'second', car: data.cars[1] },
                    { prefix: 'third', car: data.cars[2] },
                    { prefix: 'fourth', car: data.cars[3] }
                ];
                
                // Update lap count
                document.getElementById('standings-title').textContent = `Standings - Lap: ${data.lap} of ${data.lap_count}`;

                standingsIds.forEach(({ prefix, car }) => {
                    if (car) {
                        document.getElementById(`${prefix}-num`).textContent = car.number;
                        document.getElementById(`${prefix}-driver`).textContent = car.name;
                        document.getElementById(`${prefix}-time-leader`).textContent = `${car.to_leader.toFixed(2)}`;  
                        document.getElementById(`${prefix}-time-total`).textContent = `${car.total_race_time.toFixed(2)}`;
                        document.getElementById(`${prefix}-tire`).textContent = `${car.tire_life.toFixed(2)}%`;
                        document.getElementById(`${prefix}-fuel`).textContent = `${car.fuel_level.toFixed(2)}%`;
                    }
                });

                // Updating the player control center (Car 1 and Car 2)
                let player_racer_array = [];

                data.cars.forEach((car) => {
                    if (car.push_tire !== null) {  // Only add player-controlled cars
                        player_racer_array.push(car);
                    }
                });

                // Update Player Car 1 Control Center
                if (player_racer_array[0]) {
                    document.getElementById('car-1-title').textContent = `#${player_racer_array[0].number} ${player_racer_array[0].name}`;
                    document.getElementById('player-car-1-tire').textContent = `Tire %: ${player_racer_array[0].tire_life.toFixed(2)}%`;
                    document.getElementById('player-car-1-fuel').textContent = `Fuel %: ${player_racer_array[0].fuel_level.toFixed(2)}%`;
                }

                // Update Player Car 2 Control Center
                if (player_racer_array[1]) {
                    document.getElementById('car-2-title').textContent = `#${player_racer_array[1].number} ${player_racer_array[1].name}`;
                    document.getElementById('player-car-2-tire').textContent = `Tire %: ${player_racer_array[1].tire_life.toFixed(2)}%`;
                    document.getElementById('player-car-2-fuel').textContent = `Fuel %: ${player_racer_array[1].fuel_level.toFixed(2)}%`;
                }

            } catch (error) {
                console.error('Error fetching race data:', error);
            }
        }

        // Function to advance the lap
        async function advanceLap() {
            try {
                await fetch('/api/race/lap', { method: 'POST' });
                getRaceData();  // Refresh data after advancing the lap
            } catch (error) {
                console.error('Error advancing lap:', error);
            }
        }

        // Function to perform pit stop for a specific player car
        function handlePitButtons() {
            document.getElementById('player-car-1-pit').addEventListener('click', async () => {
                try {
                    await fetch('/api/race/pit', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ number: 1 })  // Car #1
                    });
                    // getRaceData();  // Refresh data after performing pit stop
                } catch (error) {
                    console.error('Error performing pit stop for Car #1:', error);
                }
            });

            document.getElementById('player-car-2-pit').addEventListener('click', async () => {
                try {
                    await fetch('/api/race/pit', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ number: 2 })  // Car #2
                    });
                    getRaceData();  // Refresh data after performing pit stop
                } catch (error) {
                    console.error('Error performing pit stop for Car #2:', error);
                }
            });
        }

        // Function to update the push strategy (aggressiveness level) for a player car
        function handleStrategyButtons() {
            document.querySelectorAll('input[name="strategy1"]').forEach(radio => {
                radio.addEventListener('change', async () => {
                    const strategyLevel = radio.value;
                    try {
                        await fetch('/api/race/strategy', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ number: 1, push_level: strategyLevel })  // Car #1
                        });
                        getRaceData();  // Refresh data after updating strategy
                    } catch (error) {
                        console.error('Error updating strategy for Car #1:', error);
                    }
                });
            });

            document.querySelectorAll('input[name="strategy2"]').forEach(radio => {
                radio.addEventListener('change', async () => {
                    const strategyLevel = radio.value;
                    try {
                        await fetch('/api/race/strategy', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ number: 2, push_level: strategyLevel })  // Car #2
                        });
                        getRaceData();  // Refresh data after updating strategy
                    } catch (error) {
                        console.error('Error updating strategy for Car #2:', error);
                    }
                });
            });
        }

        // Function to reset the race
        async function resetRace() {
            try {
                await fetch('/api/race/reset', { method: 'POST' });
                getRaceData();  // Refresh data after resetting the race
            } catch (error) {
                console.error('Error resetting race:', error);
            }
        }

        // Initialize the page when it loads
        document.addEventListener('DOMContentLoaded', () => {
            getRaceData();
            handlePitButtons();
            handleStrategyButtons();

            // Set up button click handlers for lap advancement and reset
            document.getElementById('lap-button').addEventListener('click', advanceLap);
            document.getElementById('reset-button').addEventListener('click', resetRace);
        });

    </script>
</body>
    <!-- OLD game input/output section -->
    <!-- 
    <div class="game-box" style="display: inline-block; text-align: left; padding: 20px; border: 1px solid #ccc; border-radius: 10px;">
        <div class="output-box" style="border: 1px solid #333; height: 200px; width: 400px; padding: 10px; margin-bottom: 10px; overflow-y: auto;">
            <p>Game output will be displayed here...</p>
        </div>
        <div class="input-box" style="display: flex;">
            <input type="text" placeholder="Enter your command..." style="flex-grow: 1; padding: 10px; border: 1px solid #333; margin-right: 10px; border-radius: 5px;">
            <button style="padding: 10px 20px; border: none; background-color: #333; color: white; cursor: pointer;">Submit</button>
        </div>
    </div>
    -->
{% endblock %}
