{% extends "base.html" %}

{% block title %}Home - NASCAR Manager '24{% endblock %}

{% block content %}
<body>
    <div class="content">
        <h1 class="main-title">NASCAR Manager '24</h1>
        <h2 class="sub-title">Update November 7, 2024</h2>

        <!-- Game Layout -->
        <div class="container" style="display: flex; gap: 20px;">
            <!-- Standings Table -->
            <div class="box box-large">
                <h3 id="standings-title" style="text-align: center;">Standings - Lap: 1</h3>
                <table class="standings-table">
                    <thead>
                        <tr>
                            <th>Position</th>
                            <th>Car #</th>
                            <th>Driver</th>
                            <th>To Leader</th>
                            <th>Total</th>
                            <th>Tire %</th>
                            <th>Fuel %</th>
                        </tr>
                    </thead>
                    <tbody id="standings-table-body">
                        <!-- Rows will be generated here by JavaScript -->
                    </tbody>
                </table>
            </div>
        
            <!-- Player Control Centers -->
            <div class="content" style="flex: 1;">

                <!-- Control Center for Car 1 -->
                <div class="box box-small">
                    <div id="player1-profile" class="profile-picture" style="margin-bottom: 10px;"></div>
                    <h3 id="car-1-title" class="sub-title">Car #1</h3>
                    <p id="player-car-1-tire"><strong>Tire %:</strong> 85%</p>
                    <p id="player-car-1-fuel"><strong>Fuel %:</strong> 75%</p>
                    <button id="player-car-1-pit" class="button button-danger">Pit</button>
                    
                    <!-- Strategy Level -->
                    <div style="margin-top: 20px;">
                        <p id="player-car-1-current-strategy"><strong>Strategy Level:</strong></p>
                        <div style="display: flex; justify-content: space-between;">
                            {% for i in range(1, 6) %}
                                <label style="display: flex; flex-direction: column; align-items: center;">
                                    <input type="radio" name="strategy1" value="{{ i }}">
                                    <span>{{ i }}</span>
                                </label>
                            {% endfor %}
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 10px;">
                            <span style="font-size: 0.9em; color: #555;">Conserve</span>
                            <span style="font-size: 0.9em; color: #555;">Attack</span>
                        </div>
                    </div>
                </div>

                <!-- Control Center for Car 2 -->
                <div class="box box-small">
                    <div id="player2-profile" class="profile-picture" style="margin-bottom: 10px;"></div>
                    <h3 id="car-2-title" class="sub-title">Car #2</h3>
                    <p id="player-car-2-tire"><strong>Tire %:</strong> 85%</p>
                    <p id="player-car-2-fuel"><strong>Fuel %:</strong> 75%</p>
                    <button id="player-car-2-pit" class="button button-danger">Pit</button>
                    
                    <!-- Strategy Level -->
                    <div style="margin-top: 20px;">
                        <p id="player-car-2-current-strategy"><strong>Strategy Level:</strong></p>
                        <div style="display: flex; justify-content: space-between;">
                            {% for i in range(1, 6) %}
                                <label style="display: flex; flex-direction: column; align-items: center;">
                                    <input type="radio" name="strategy2" value="{{ i }}">
                                    <span>{{ i }}</span>
                                </label>
                            {% endfor %}
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 10px;">
                            <span style="font-size: 0.9em; color: #555;">Conserve</span>
                            <span style="font-size: 0.9em; color: #555;">Attack</span>
                        </div>
                    </div>
                </div>

                <!-- Advance and Reset Buttons -->
                <div style="margin-top: 30px;">
                    <button id="lap-button" class="button button-danger">Advance Lap</button>
                    <button id="reset-button" class="button button-danger">Reset</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT FOR HANDLING GAME LOGIC BELOW -->
    <script>
        let player_racer_array = [];
        let player_car_1_pit_boolean = [];
        let player_car_2_pit_boolean = [];
    
        // Data for the cars
        const carData = Array.from({ length: 16 }, (_, i) => ({
            position: i + 1,
            carNumber: '--',
            driver: '--',
            toLeader: '--',
            totalTime: '--',
            tire: '--',
            fuel: '--'
        }));
    
        const tableBody = document.getElementById("standings-table-body");
    
        // Generate rows dynamically based on carData
        carData.forEach(car => {
            const row = document.createElement("tr");
            
            row.innerHTML = `
                <td>${car.position}</td>
                <td id="car-${car.position}-num">${car.carNumber}</td>
                <td id="car-${car.position}-driver">${car.driver}</td>
                <td id="car-${car.position}-to-leader">${car.toLeader}</td>
                <td id="car-${car.position}-time-total">${car.totalTime}</td>
                <td id="car-${car.position}-tire">${car.tire}</td>
                <td id="car-${car.position}-fuel">${car.fuel}</td>
            `;
            
            tableBody.appendChild(row);
        });
    
        async function startRace() {
            try {
                const response = await fetch('/api/race');
                const data = await response.json();
                
                // Identify player-controlled cars
                player_racer_array = data.cars.filter(car => car.ai_or_player != 3);
                
                if (player_racer_array[0]) {
                    document.getElementById('car-1-title').textContent = `#${player_racer_array[0].number} ${player_racer_array[0].name}`;
                }
                if (player_racer_array[1]) {
                    document.getElementById('car-2-title').textContent = `#${player_racer_array[1].number} ${player_racer_array[1].name}`;
                }
    
            } catch (error) {
                console.error('Error starting race', error);
            }
        }
    
        async function getRaceData() {
            try {
                const response = await fetch('/api/race');
                const data = await response.json();
                
                player_racer_array = data.cars.filter(car => car.ai_or_player != 3);
                player_racer_array.sort((a, b) => a.ai_or_player - b.ai_or_player);


                // Update lap count
                document.getElementById('standings-title').textContent = `Standings - Lap: ${data.lap} of ${data.lap_count}`;
    
                // Update standings for each car
                data.cars.forEach((car, index) => {
                    if (car) {
                        document.getElementById(`car-${index + 1}-num`).textContent = car.number;
                        document.getElementById(`car-${index + 1}-driver`).textContent = car.name;
                        document.getElementById(`car-${index + 1}-to-leader`).textContent = car.to_leader.toFixed(2);
                        document.getElementById(`car-${index + 1}-time-total`).textContent = car.total_race_time.toFixed(2);
                        document.getElementById(`car-${index + 1}-tire`).textContent = `${car.tire_life.toFixed(2)}%`;
                        document.getElementById(`car-${index + 1}-fuel`).textContent = `${car.fuel_level.toFixed(2)}%`;
                    }
                });
    
                // Update Player Car Control Centers
                if (player_racer_array[0]) {
                    document.getElementById('player-car-1-current-strategy').textContent = `Strategy Level: ${player_racer_array[0].push_tire}`;
                    document.getElementById('player-car-1-tire').textContent = `Tire %: ${player_racer_array[0].tire_life.toFixed(2)}%`;
                    document.getElementById('player-car-1-fuel').textContent = `Fuel %: ${player_racer_array[0].fuel_level.toFixed(2)}%`;
                }
    
                if (player_racer_array[1]) {
                    document.getElementById('player-car-2-current-strategy').textContent = `Strategy Level: ${player_racer_array[1].push_tire}`;
                    document.getElementById('player-car-2-tire').textContent = `Tire %: ${player_racer_array[1].tire_life.toFixed(2)}%`;
                    document.getElementById('player-car-2-fuel').textContent = `Fuel %: ${player_racer_array[1].fuel_level.toFixed(2)}%`;
                }
    
            } catch (error) {
                console.error('Error fetching race data:', error);
            }
        }
    
        async function advanceLap() {
            try {
                await fetch('/api/race/lap', { method: 'POST' });
                getRaceData();  // Refresh data after advancing the lap
                player_car_1_pit_boolean = false;
                player_car_2_pit_boolean = false;
            } catch (error) {
                console.error('Error advancing lap:', error);
            }
        }
    
        function handlePitButtons() {
            document.getElementById('player-car-1-pit').addEventListener('click', async () => {
                try {
                    if (player_car_1_pit_boolean != true) {
                        player_car_1_pit_boolean = true;
                        await fetch('/api/race/pit', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ number: player_racer_array[0].number })
                        });
                        console.log(`${player_racer_array[0].number} Entered pit`);
                        getRaceData();  // Refresh data after performing pit stop
                    } else {
                        console.log(`${player_racer_array[0]} already entered pit!`)
                    }
                } catch (error) {
                    console.error('Error performing pit stop for Car #1:', error);
                }
            });
    
            document.getElementById('player-car-2-pit').addEventListener('click', async () => {
                try {
                    if (player_car_2_pit_boolean != true) {
                        player_car_2_pit_boolean = true;
                        await fetch('/api/race/pit', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ number: player_racer_array[1].number })
                        });
                        console.log(`${player_racer_array[1].number} Entered pit`);
                        getRaceData();  // Refresh data after performing pit stop
                    } else {
                        console.log(`${player_racer_array[1]} already entered pit!`)
                    }
                } catch (error) {
                    console.error('Error performing pit stop for Car #2:', error);
                }
            });
        }
    
        function handleStrategyButtons() {
            document.querySelectorAll('input[name="strategy1"]').forEach(radio => {
                radio.addEventListener('change', async () => {
                    const strategyLevel = radio.value;
                    try {
                        await fetch('/api/race/strategy', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ number: player_racer_array[0].number, push_level: strategyLevel })
                        });
                        getRaceData();  // Refresh data after updating strategy
                    } catch (error) {
                        console.error('Error updating strategy for Car #1:', error);
                    }
                });
            });
    
            document.querySelectorAll('input[name="strategy2"]').forEach(radio => {
                radio.addEventListener('change', async () => {
                    const strategyLevel = radio.value;
                    try {
                        await fetch('/api/race/strategy', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ number: player_racer_array[1].number, push_level: strategyLevel })
                        });
                        getRaceData();  // Refresh data after updating strategy
                    } catch (error) {
                        console.error('Error updating strategy for Car #2:', error);
                    }
                });
            });
        }
    
        async function resetRace() {
            try {
                await fetch('/api/race/reset', { method: 'POST' });
                getRaceData();  // Refresh data after resetting the race
                
                // Unselect all strategy1 radio buttons
                document.querySelectorAll('input[name="strategy1"]').forEach(radio => {
                    radio.checked = false;
                });

                // Unselect all strategy2 radio buttons
                document.querySelectorAll('input[name="strategy2"]').forEach(radio => {
                    radio.checked = false;
                });

            } catch (error) {
                console.error('Error resetting race:', error);
            }
        }
    
        document.addEventListener('DOMContentLoaded', () => {
            startRace();
            getRaceData();
            handlePitButtons();
            handleStrategyButtons();
    
            document.getElementById('lap-button').addEventListener('click', advanceLap);
            document.getElementById('reset-button').addEventListener('click', resetRace);

            // Retrieve player information from localStorage
            const player1Name = localStorage.getItem("player1Name") || "Player 1";
            const player1Car = localStorage.getItem("player1Car") || "00";
            const player1Picture = localStorage.getItem("player1Picture") || "profile1.png";
            
            const player2Name = localStorage.getItem("player2Name") || "Player 2";
            const player2Car = localStorage.getItem("player2Car") || "00";
            const player2Picture = localStorage.getItem("player2Picture") || "profile2.png";

            // Update player information in the HTML
            document.getElementById("car-1-title").textContent = `${player1Name} - Car #${player1Car}`;
            document.getElementById("car-2-title").textContent = `${player2Name} - Car #${player2Car}`;

            // Update player profile pictures
            document.getElementById("player1-profile").style.backgroundImage = `url('/static/images/profiles/${player1Picture}')`;
            document.getElementById("player2-profile").style.backgroundImage = `url('/static/images/profiles/${player2Picture}')`;

        });
    </script>
    
</body>
    <!-- OLD game input/output section -->
    <!-- 
    <div class="game-box" style="display: inline-block; text-align: left; padding: 20px; border: 1px solid #ccc; border-radius: 10px;">
        <div class="output-box" style="border: 1px solid #333; height: 200px; width: 400px; padding: 10px; margin-bottom: 10px; overflow-y: auto;">
            <p>Game output will be displayed here...</p>
        </div>
        <div class="input-box" style="display: flex;">
            <input type="text" placeholder="Enter your command..." style="flex-grow: 1; padding: 10px; border: 1px solid #333; margin-right: 10px; border-radius: 5px;">
            <button style="padding: 10px 20px; border: none; background-color: #333; color: white; cursor: pointer;">Submit</button>
        </div>
    </div>
    -->
{% endblock %}
